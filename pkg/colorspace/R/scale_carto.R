#' Discrete CARTO scales for ggplot2, emulated by HCL palettes
#'
#' Discrete ggplot2 color scales using the color palettes generated by \code{\link{carto_hcl}}.
#' 
#' Available sequential palettes: RedOr, OrYel, Peach, PinkYl, Mint, BluGrn,
#' DarkMint, Emrld, ag_GrnYl, BluYl, Teal, TealGrn, PurpOr, Sunset, Magenta.
#'
#' Available diverging palettes: ArmyRose, Fall, Geyser, Temps, Tropic, Earth.
#' 
#' If both a valid palette name and palette parameters are provided then the provided palette parameters overwrite the parameters in the
#' named palette. This enables easy customization of named palettes.
#' 
#' @param alpha Numeric vector of values in the range \code{[0, 1]} for alpha transparency channel (0 means transparent and 1 means opaque).
#' @param palette The name of the palette to be used.
#' @param rev If \code{TRUE}, reverses the order of the colors in the color scale.
#' @param h1,h2,h3,c1,c2,c3,l1,l2,l3,p1,p2,p3,p4 Parameters to customize the scale. See \code{\link{carto_hcl}} for details.
#' @param nmax Maximum number of different colors the palette should contain. If not provided, is calculated automatically
#'  from the data.
#' @param order Numeric vector listing the order in which the colors should be used. Default is \code{1:nmax}.
#' @param aesthetics The ggplot2 aesthetics to which this scale should be applied.
#' @param ... common discrete scale parameters: \code{name}, \code{breaks}, \code{labels}, \code{na.value}, \code{limits} and \code{guide}. See
#'  \code{\link[ggplot2]{discrete_scale}} for more details.
#' @examples
#' library(ggplot2)
#' 
#' # default color scale
#' ggplot(iris, aes(Sepal.Length, Sepal.Width, color = Species)) +
#'   geom_point() + theme_minimal() + 
#'   scale_color_discrete_carto()
#' 
#' # color scale "Tropic"
#' ggplot(iris, aes(Sepal.Length, fill = Species)) +
#'   geom_density(alpha = 0.7) + theme_classic() +
#'     scale_fill_discrete_carto(palette = "Tropic", rev = TRUE)
#'     
#' # use `nmax` and `order` to skip some colors
#' ggplot(iris, aes(Sepal.Length, fill = Species)) +
#'   geom_density(alpha = 0.7) + theme_classic() +
#'     scale_fill_discrete_carto(palette = "Tropic", nmax = 5, order = c(1, 4, 5))
#' @importFrom stats na.omit
#' @export
scale_colour_discrete_carto <- function(palette = "DarkMint", c1 = NULL, c2 = NULL, c3 = NULL,
                                            l1 = NULL, l2 = NULL, l3 = NULL, h1 = NULL, h2 = NULL,
                                            h3 = NULL, p1 = NULL, p2 = NULL, p3 = NULL, p4 = NULL,
                                            alpha = 1, rev = FALSE, nmax = NULL, order = NULL,
                                            aesthetics = "colour", ...)
{
  # arguments we want to hand off to function carto_hcl only if explicitly provided
  hcl_args <- c("c1", "c2", "c3", "l1", "l2", "l3", "h1", "h2", "h3", "p1", "p2",
                "p3", "p4")
  
  # match hcl_args to args provided
  args <- as.list(match.call())
  args[[1]] <- NULL # remove the function call
  args <- args[na.omit(match(hcl_args, names(args)))] # remove other args
  
  pal <- function(n) {
    if (is.null(nmax)) nmax <- n
    if (is.null(order)) order <- 1:n
    
    if (n > nmax) {
      warning("Insufficient values in scale_colour_discrete_diverging. ", n, " needed but only ",
              nmax, " provided.", call. = FALSE)
    }
    # set the remaining arguments and call qualitative_hcl
    args <- c(args, list(palette = palette, n = nmax, alpha = alpha, rev = rev))
    do.call(carto_hcl, args, envir = parent.frame())[order]
  }
  ggplot2::discrete_scale(aesthetics, "manual", pal, ...)
}

#' @rdname scale_colour_discrete_carto
#' @export
scale_color_discrete_carto <- function(...) scale_colour_discrete_carto(...)

#' @rdname scale_colour_discrete_carto
#' @export
scale_fill_discrete_carto <- function(...) scale_colour_discrete_carto(..., aesthetics = "fill")

  
  
#' Continuous CARTO scales for ggplot2, emulated by HCL palettes
#'
#' Continuous ggplot2 color scales using the color palettes generated by \code{\link{carto_hcl}}.
#'
#' Available sequential palettes: RedOr, OrYel, Peach, PinkYl, Mint, BluGrn,
#' DarkMint, Emrld, ag_GrnYl, BluYl, Teal, TealGrn, PurpOr, Sunset, Magenta.
#'
#' Available diverging palettes: ArmyRose, Fall, Geyser, Temps, Tropic, Earth.
#' 
#' If both a valid palette name and palette parameters are provided then the provided palette parameters overwrite the parameters in the
#' named palette. This enables easy customization of named palettes.
#' 
#' @inheritParams scale_colour_discrete_carto
#' @param h1,h2,h3,c1,c2,c3,l1,l2,l3,p1,p2,p3,p4 Parameters to customize the scale. See \code{\link{carto_hcl}} for details.
#' @param begin For sequential scales, number in the range of \code{[0, 1]} indicating to which point in the color scale the 
#'  smallest data value should be mapped. Ignored for diverging scales.
#' @param end For sequential scales, number in the range of \code{[0, 1]} indicating to which point in the color scale the
#'  largest data value should be mapped. Ignored for diverging scales.
#' @param mid For diverging scales, data value that should be mapped to the mid-point of the diverging
#'  color scale. Ignored for sequential scales.
#' @param na.value Color to be used for missing data points.
#' @param guide Type of legend. Use \code{"colourbar"} for continuous color bar. 
#' @param n_interp Number of discrete colors that should be used to interpolate the continuous color scale.
#'   For diverging scales, it is important to use an odd number to capture the color at the midpoint.
#' @param ... common continuous scale parameters: `name`, `breaks`, `labels`, and `limits`. See
#'  \code{\link[ggplot2]{continuous_scale}} for more details.
#' @examples
#' # *** Examples for sequential CARTO scales ***
#' 
#' # base plot
#' library(ggplot2)
#' gg <- ggplot(iris, aes(x = Species, y = Sepal.Width, color = Sepal.Length)) + 
#'   geom_jitter(width = 0.3) + theme_minimal()
#' 
#' # default settings
#' gg + scale_color_continuous_carto()
#' 
#' # switch palette to blue-yellow
#' gg + scale_color_continuous_carto(palette = "BluYl")
#' 
#' # select a range out of the entire palette
#' gg + scale_color_continuous_carto(palette = "BluYl", begin = .2, end = .8)
#' 
#' # volcano plot
#' nx = 87
#' ny = 61
#' df <- data.frame(height = c(volcano), x = rep(1:nx, ny), y = rep(1:ny, each = nx))
#' ggplot(df, aes(x, y, fill=height)) + 
#'   geom_raster() + scale_fill_continuous_carto(palette = "Emrld", rev = TRUE) +
#'   coord_fixed(expand = FALSE)
#'
#'
#' # *** Examples for diverging CARTO scales ***
#' 
#' # adapted from stackoverflow: https://stackoverflow.com/a/20127706/4975218
#'
#' # generate dataset and base plot
#' library(ggplot2)
#' set.seed(100)
#' df <- data.frame(country = LETTERS, V = runif(26, -40, 40))
#' df$country = factor(LETTERS, LETTERS[order(df$V)]) # reorder factors
#' gg <- ggplot(df, aes(x = country, y = V, fill = V)) +
#'   geom_bar(stat = "identity") +
#'   labs(y = "Under/over valuation in %", x = "Country") +
#'   coord_flip() + theme_minimal()
#'   
#' # plot with diverging scale "Geyser"
#' gg + scale_fill_continuous_carto(palette = "Geyser")
#'
#' # plot with diverging scale "ArmyRose"
#' gg + scale_fill_continuous_carto(palette = "ArmyRose")
#' @importFrom stats na.omit
#' @export
scale_colour_continuous_carto <- function(palette = "DarkMint", c1 = NULL, c2 = NULL, c3 = NULL,
                                          l1 = NULL, l2 = NULL, l3 = NULL, h1 = NULL, h2 = NULL,
                                          h3 = NULL, p1 = NULL, p2 = NULL, p3 = NULL, p4 = NULL,
                                          rev = FALSE, begin = 0, end = 1, mid = 0, na.value = "grey50",
                                          guide = "colourbar", n_interp = 11, aesthetics = "colour", ...)
{
  # arguments we want to hand off to function carto_hcl only if explicitly provided
  hcl_args <- c("c1", "c2", "c3", "l1", "l2", "l3", "h1", "h2", "h3", "p1", "p2",
                "p3", "p4")
  
  # match hcl_args to args provided
  args <- as.list(match.call())
  args[[1]] <- NULL # remove the function call
  args <- args[na.omit(match(hcl_args, names(args)))] # remove other args
  
  # set the remaining arguments and call qualitative_hcl
  # alpha argument doesn't seem to work for continuous scale
  args <- c(args, list(palette = palette, n = n_interp, rev = rev))
  colors <- do.call(carto_hcl, args, envir = parent.frame())
  
  # determine whether we're dealing with a sequential or continuous scale
  if (palette %in% c("ArmyRose", "Fall", "Geyser", "Temps", "Tropic", "Earth") || !is.null(h3))
  {
    # diverging scale
    rescaler = mid_rescaler(mid)
  }
  else {
    # sequential scale
    rescaler = to_rescaler(begin, end)
  }
  ggplot2::continuous_scale(aesthetics, "continuous_carto",
                            scales::gradient_n_pal(colors, values = NULL),
                            na.value = na.value, guide = guide,
                            rescaler = rescaler, ...)
}

#' @rdname scale_colour_continuous_carto
#' @export
scale_color_continuous_carto <- function(...) scale_colour_continuous_carto(...)

#' @rdname scale_colour_continuous_carto
#' @export
scale_fill_continuous_carto <- function(...) scale_colour_continuous_carto(..., aesthetics = "fill")
